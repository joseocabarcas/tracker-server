!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define("tracker-server",[],t):"object"==typeof exports?exports["tracker-server"]=t():e["tracker-server"]=t()}(global,function(){return function(e){var t={};function i(o){if(t[o])return t[o].exports;var n=t[o]={i:o,l:!1,exports:{}};return e[o].call(n.exports,n,n.exports,i),n.l=!0,n.exports}return i.m=e,i.c=t,i.d=function(e,t,o){i.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:o})},i.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},i.t=function(e,t){if(1&t&&(e=i(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var o=Object.create(null);if(i.r(o),Object.defineProperty(o,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var n in e)i.d(o,n,function(t){return e[t]}.bind(null,n));return o},i.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return i.d(t,"a",t),t},i.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},i.p="",i(i.s=1)}([function(e,t){e.exports=require("events")},function(e,t,i){e.exports=i(3).default},function(e,t){e.exports=require("net")},function(e,t,i){"use strict";i.r(t);const o=i(0);class n extends o{constructor(e,t,i){super(),this.connection=t,this.server=i,this.uid=!1,this.ip=t.ip,this.port=t.port,this.name=!1,this.authenticated=!1,this.deviceId=null,this.adapter=new e(this),this.on("data",e=>{var t=this.adapter.parseData(e);this.deviceId=t.device_id,this.makeAction(t.action,t.message)})}send(e){this.emit("send_data",e),this.connection.write(e)}makeAction(e,t){if(console.log("autenticado",!this.authenticated),!this.authenticated)return console.log("No autenticado"),!1;switch(e){case"login":this.login(t);break;case"online":this.online(t);break;case"location":this.adapter.setLocation(t);break;case"alert":this.adapter.setAlert(t);break;case"response":break;default:this.adapter.doLog(t)}}login(e){console.log("logueame"),this.emit("login",this.deviceId,e)}loginAuthorize(e,t){e?(console.log("GPS autorizado",this.deviceId),this.authenticated=!0,this.adapter.authorize(t)):console.log("GPS no autorizado",this.deviceId)}online(e){this.adapter.sendOk("ON")}}class s{constructor(e){this.device=e}parseData(e){e=e.toString(),console.log(e);let t={device_id:"",status:"",action:"",data:""};if(e.includes("##")){const i=["code","imei","status"],o=e.split(","),n=i.map((e,t)=>[e,o[t]]);console.log(new Map(n));const s=new Map(n);t.action="login",t.data=e,t.device_id=s.get("imei"),t.status="LOAD"}if(15==e.length&&(t.action="online",t.data=e,t.device_id=e,t.status="ON"),e.length>26){const i=["imei","status","time","empty","a2","b1","b2","c1","c2","d1","d2","speed"],o=e.split(","),n=i.map((e,t)=>[e,o[t]]);console.log(new Map(n));const s=new Map(n);switch(t.data=e,t.device_id=s.get("imei"),s.get("status")){case"001":case"tracker":t.action="location";break;case"sensor alarm":t.action="alert",t.status=s.get("status");break;default:t.action="other",t.status=s.get("status")}}return t}sendOk(e){this.device.send(e)}sendCommand(e){var t=`**,${e},B`;console.log(t),this.device.send(t)}generateCommand(e,t){}authorize(e){this.sendOk("LOAD")}doLog(e){console.log(e)}setLocation(e){console.log(e)}}i.d(t,"default",function(){return a});const r=i(0),c=i(2);class a extends r{constructor(e,t){super(),this.defaults={port:8090},this.opts=Object.assign(this.defaults,e),this.devices=[],this.server=!1,this.cb=t,this.init(()=>{this.server=c.createServer(e=>{console.log("alguien se conecto"),e.device=new n(s,e,this),this.devices.push(e),e.on("data",function(t){console.log("data"),console.log(t),e.device.emit("data",t)}),e.on("end",()=>{console.log("end"),this.devices.splice(this.devices.indexOf(e),1),e.device.emit("disconnected")}),e.on("error",e=>{console.log("error"),console.log(e)}),e.on("close",t=>{console.log("close"),console.log(t),this.devices.splice(this.devices.indexOf(e),1),e.device.emit("disconnected")}),this.cb(e.device,e),e.device.emit("connected")}).listen(this.opts.port)})}init(e){this.emit("before_init"),"function"==typeof e&&e(),this.emit("init"),console.log("\n=================================================\nGPS LISTENER running at port "+this.opts.port)}find_device(e){for(var t in this.devices){var i=this.devices[t].device;if(i.uid===e)return i}return!1}send_to(e,t){this.find_device(e).send(t)}}}])});
//# sourceMappingURL=tracker-server.min.js.map